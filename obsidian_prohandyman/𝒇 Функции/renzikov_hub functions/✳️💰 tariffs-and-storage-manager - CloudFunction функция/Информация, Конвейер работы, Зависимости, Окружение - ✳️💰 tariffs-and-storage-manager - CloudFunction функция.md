
–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä - d4eldr0g66rsnknt8cvf
–û–ø–∏—Å–∞–Ω–∏–µ - üí∞ –£–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–∞—Ä–∏—Ñ–∞–º–∏, –∫–≤–æ—Ç–∞–º–∏ –∏ —Ñ–∞–π–ª–∞–º–∏ –≤ Object Storage.
–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ - index.handler
–¢–∞–π–º–∞—É—Ç - 20 —Å–µ–∫

---

–ù–∞ –≤—Ö–æ–¥–µ:
	-> `Authorization: Bearer <jwt_token>`: –¢–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ API Gateway —á–µ—Ä–µ–∑ auth-gate).
	-> `user_id` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ç–æ—Ä–æ–º auth-gate.
	-> –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:
		- `action` (string, **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**): –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏.
		- `firm_id` (string, **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**): ID —Ñ–∏—Ä–º—ã.
		- **–î–ª—è `GET_RECORD`**:
			- –ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø. –ø–æ–ª–µ–π.
		- **–î–ª—è `UPDATE_JSON`**:
			- `target_json_field` (string): –ò–º—è JSON-–ø–æ–ª—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (`subscription_info_json`, `storage_info_json`, `confidential_data_json`).
			- `updates` (object): –°–ª–æ–≤–∞—Ä—å —Å –∫–ª—é—á–∞–º–∏ –∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
		- **–î–ª—è `CLEAR_JSON`**:
			- `fields_to_clear` (list): –°–ø–∏—Å–æ–∫ JSON-–ø–æ–ª–µ–π –¥–ª—è –æ—á–∏—Å—Ç–∫–∏.
		- **–î–ª—è `GET_UPLOAD_URL`**:
			- `filename` (string): –ò–º—è —Ñ–∞–π–ª–∞.
			- `filesize` (integer): –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –±–∞–π—Ç–∞—Ö.
		- **–î–ª—è `DELETE_FILE`**:
			- `file_key` (string): –ö–ª—é—á —Ñ–∞–π–ª–∞ –≤ S3.

–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ä–∞–±–æ—Ç–∞:
    -> –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –≤—ã–∑–æ–≤–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –¥—Ä–∞–π–≤–µ—Ä–æ–≤ YDB.
    -> –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:
        -> –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è `user_id` –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ç–æ—Ä–∞ API Gateway (`requestContext.authorizer.user_payload`). JWT –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ —Ñ—É–Ω–∫—Ü–∏–µ–π [[üõ°Ô∏è auth-gate - CloudFunction —Ñ—É–Ω–∫—Ü–∏—è]] –¥–æ –≤—ã–∑–æ–≤–∞ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.
    -> –ü–∞—Ä—Å–∏–Ω–≥ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å –ø–æ–º–æ—â—å—é request_parser.
    -> –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: firm_id –∏ action.
    -> –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–∞–º –¥–∞–Ω–Ω—ã—Ö firms –∏ tariffs.
    -> –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–ª–µ–Ω—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–∏—Ä–º–µ –∏ –ø—Ä–∞–≤ (OWNER/ADMIN –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π).
    -> –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ action:
        -> GET_RECORD (—Ç—Ä–µ–±—É–µ—Ç ADMIN/OWNER):
            -> –í—ã–∑–æ–≤ get_or_create_record: –ø–æ–∏—Å–∫ –∑–∞–ø–∏—Å–∏, –µ—Å–ª–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞–Ω–∏–µ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ (quota 100MB).
        -> UPDATE_JSON (—Ç—Ä–µ–±—É–µ—Ç ADMIN/OWNER):
            -> –í—ã–∑–æ–≤ update_json_fields: —á—Ç–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ JSON, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π, –∑–∞–ø–∏—Å—å –æ–±—Ä–∞—Ç–Ω–æ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º timestamps.
        -> CLEAR_JSON (—Ç—Ä–µ–±—É–µ—Ç ADMIN/OWNER):
            -> –í—ã–∑–æ–≤ clear_json_fields: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö JSON-–ø–æ–ª–µ–π –≤ {} —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º timestamps.
        -> GET_UPLOAD_URL:
            -> –í—ã–∑–æ–≤ handle_get_upload_url: —Ä–∞—Å—á–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–∑ S3, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç—ã, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–î –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è pre-signed PUT URL.
        -> GET_DOWNLOAD_URL:
            -> –í—ã–∑–æ–≤ handle_get_download_url: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è pre-signed GET URL –¥–ª—è —Ñ–∞–π–ª–∞.
        -> CONFIRM_UPLOAD:
            -> –í—ã–∑–æ–≤ handle_confirm_upload: –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ –∏–∑ S3, –∞—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ used_bytes –≤ storage_info_json.
        -> DELETE_FILE:
            -> –í—ã–∑–æ–≤ handle_delete_file: –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞, —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ S3, –∞—Ç–æ–º–∞—Ä–Ω–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ used_bytes –≤ storage_info_json.
    -> –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π: –≤–æ–∑–≤—Ä–∞—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ (400, 403, 404, 413, 500).

–ù–∞ –≤—ã—Ö–æ–¥–µ:
-   `200 OK` (GET_RECORD): `{"data": {...}}`
-   `200 OK` (UPDATE_JSON/CLEAR_JSON): `{"message": "..."}`
-   `200 OK` (GET_UPLOAD_URL): `{"upload_url": "...", "file_key": "..."}`
-   `200 OK` (DELETE_FILE): `{"message": "File deleted"}`
-   `400 Bad Request`, `403 Forbidden`, `404 Not Found`, `413 Payload Too Large`.

---
#### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
-   **–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —É—Ç–∏–ª–∏—Ç—ã**: `utils/ydb_utils.py`, `utils/request_parser.py`, `utils/storage_utils.py`, `utils/util_yc_sa/*`
-   **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**: –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é [[üõ°Ô∏è auth-gate - CloudFunction —Ñ—É–Ω–∫—Ü–∏—è]] –Ω–∞ —É—Ä–æ–≤–Ω–µ API Gateway
-   **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**:
    -   `YDB_ENDPOINT_FIRMS`, `YDB_DATABASE_FIRMS` ([[üíæ firms-database - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö YandexDatabase]])
    -   `YDB_ENDPOINT_TARIFFS`, `YDB_DATABASE_TARIFFS` ([[üíæ tariffs-and-storage-database - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö YandexDatabase]])
    -   `YC_LOCKBOX_SECRET_ID` - secret_id Lockbox —Å authorized key JSON
    -   `YC_LOCKBOX_VERSION_ID` - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –≤–µ—Ä—Å–∏—è —Å–µ–∫—Ä–µ—Ç–∞
    -   `YC_LOCKBOX_KEY_FIELD` - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∏–º—è –ø–æ–ª—è –≤ —Å–µ–∫—Ä–µ—Ç–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é key.json)
    -   `STORAGE_BUCKET_NAME`
    -   `STORAGE_ENDPOINT` ("https://storage.yandexcloud.net")
    -   `STORAGE_REGION` ("ru-central1")
    -   `STORAGE_ACCESS_KEY` ([[üóùÔ∏è auth-service-acc - –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞]])
    -   `STORAGE_SECRET_KEY` ([[üóùÔ∏è auth-service-acc - –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞]])
