–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä - [–ë–£–î–ï–¢_–°–û–ó–î–ê–ù]
–û–ø–∏—Å–∞–Ω–∏–µ - üî¢ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ—Ä—è–¥–∫–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ (–Ω–æ–º–µ—Ä–∫–æ–≤) —Å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é
–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ - index.handler
–¢–∞–π–º–∞—É—Ç - 10 —Å–µ–∫

---

### –ö–æ–Ω–≤–µ–π–µ—Ä —Ä–∞–±–æ—Ç—ã

–ù–∞ –≤—Ö–æ–¥–µ:
	-> `entity_type` (string, **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**): –¢–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏/–∞–≥—Ä–µ–≥–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "deal", "shift").
	-> `uuid` (string, **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**): –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–≥—Ä–µ–≥–∞—Ç–∞ (UUID).

–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ä–∞–±–æ—Ç–∞:
	-> –ü–∞—Ä—Å–∏–Ω–≥ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞: `parse_event(event)` –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è `entity_type` –∏ `uuid`.
	-> –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
		-> –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è `entity_type` –∏ `uuid`.
		-> –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ UUID –¥–ª—è `uuid`.
	-> –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ YDB (metadata-system database):
		-> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `get_session_pool_from_env()` —Å fallback –Ω–∞ `YDB_ENDPOINT_META` / `YDB_DATABASE_META`.
	-> –í —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (pool.retry_operation_sync):
		-> –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤ `aggregate_state`:
			-> –ó–∞–ø—Ä–æ—Å: `SELECT last_seq_no FROM aggregate_state WHERE entity_type = $et AND uuid = $uid`.
			-> –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –Ω–∞–π–¥–µ–Ω–∞:
				-> –í–æ–∑–≤—Ä–∞—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ `last_seq_no` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `EXISTING`.
			-> –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:
				-> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ—Ä—è–¥–∫–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞:
					-> –ó–∞–ø—Ä–æ—Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –Ω–æ–º–µ—Ä–∞: `SELECT MAX(last_seq_no) as max_no FROM aggregate_state`.
					-> –ü–∞—Ä—Å–∏–Ω–≥ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏, –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç –Ω–∞ 1.
					-> –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–µ–¥—É—â–∏—Ö –Ω—É–ª–µ–π –∏ –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª).
				-> –í—Å—Ç–∞–≤–∫–∞ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏:
					-> `INSERT INTO aggregate_state (entity_type, uuid, last_seq_no, updated_at) VALUES ($et, $uid, $new_no, $now)`.
				-> –í–æ–∑–≤—Ä–∞—Ç –Ω–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `NEW`.
	-> –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π:
		-> `EventParseError`, `BadRequest` ‚Üí `400 Bad Request`.
		-> `Internal` ‚Üí `500 Internal Server Error`.
		-> `Exception` (–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ) ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å trace/backtrace, `500 Internal Server Error`.

–ù–∞ –≤—ã—Ö–æ–¥–µ:
	-> `200 OK` (NEW): `{ "status": "NEW", "entity_type": "...", "uuid": "...", "sequence_number": "42" }`
	-> `200 OK` (EXISTING): `{ "status": "EXISTING", "entity_type": "...", "uuid": "...", "sequence_number": "42" }`
	-> `400 Bad Request`: –ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞.
	-> `500 Internal Server Error`: –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

---
#### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
- **–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —É—Ç–∏–ª–∏—Ç—ã**: `utils/util_http/request.py` (parse_event), `utils/util_http/response.py` (ok/bad_request/server_error), `utils/util_ydb/driver.py` (get_session_pool, get_session_pool_from_env), `utils/util_ydb/credentials.py` (ydb_creds_from_env), `utils/util_time/index.py` (now_utc), `utils/util_invoke/invoke.py` (invoke_function) ‚Äî –¥–ª—è –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.
- **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**:
	- `YDB_ENDPOINT_META`, `YDB_DATABASE_META` (metadata-system YDB –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `aggregate_state`)
	- `SA_KEY_JSON` (JSON –∫–ª—é—á —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –∏–∑ Lockbox; —Ñ—É–Ω–∫—Ü–∏—è —Å–∞–º–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç –µ–≥–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ YDB)

---
#### –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –µ–¥–∏–Ω–∞—è –¥–ª—è –≤—Å–µ—Ö `entity_type` (–≤—Å—ë —Ç–∞–±–ª–∏—Ü–∞ `aggregate_state`), —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ—Ä—è–¥–∫–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–∫–æ–≤ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–∏–ø–∞ —Å—É—â–Ω–æ—Å—Ç–∏.
- –ü–æ–ª–µ `last_seq_no` —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ `Utf8` (—Å—Ç—Ä–æ–∫–∞) ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª –∏ –≤–µ–¥—É—â–∏—Ö –Ω—É–ª–µ–π.
- –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é YDB (SerializableReadWrite) + –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ `MAX(last_seq_no)` –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ; –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –≥–æ–Ω–æ–∫/–ø—Ä–æ–±–ª–µ–º —Å –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å—é –º–æ–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É-—Å—á—ë—Ç—á–∏–∫ –∏–ª–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é pre-alloc –±–ª–æ–∫–æ–≤ (batch allocation).
- –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –≤—ã–∑–æ–≤—ã (—á–µ—Ä–µ–∑ `utils.util_invoke.invoke_function`) ‚Äî —Å—Ç–∞–≤–∏—Ç—å –µ—ë –∑–∞ –ø—É–±–ª–∏—á–Ω—ã–π API Gateway —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π.
