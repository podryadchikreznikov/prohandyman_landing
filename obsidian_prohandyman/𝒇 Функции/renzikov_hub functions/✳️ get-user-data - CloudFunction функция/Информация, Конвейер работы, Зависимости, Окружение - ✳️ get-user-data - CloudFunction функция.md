
–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä - d4e6qqejob02kq2j8l4l
–û–ø–∏—Å–∞–Ω–∏–µ - üì• –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–Ω—Ñ–æ, —Ñ–∏—Ä–º—ã) –ø–æ JWT —Ç–æ–∫–µ–Ω—É.
–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ - index.handler
–¢–∞–π–º–∞—É—Ç - 15 —Å–µ–∫

---

–ù–∞ –≤—Ö–æ–¥–µ:
	-> **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ë–ï–ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)**: `user_id` –≤ query-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö (`?user_id=...`) –∏–ª–∏ –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞ (`{"user_id": "..."}`).
	-> **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2**: `Authorization: Bearer <jwt_token>` —á–µ—Ä–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ç–æ—Ä API Gateway (auth-gate) ‚Äî `user_id` –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ `requestContext.authorizer.user_payload`.
	-> **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3**: `Authorization: Bearer <jwt_token>` –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ ‚Äî –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è JWT —á–µ—Ä–µ–∑ `verify_jwt` (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è).

–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ä–∞–±–æ—Ç–∞:
	-> **CORS preflight**: –û–±—Ä–∞–±–æ—Ç–∫–∞ OPTIONS-–∑–∞–ø—Ä–æ—Å–æ–≤ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º CORS-–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
	-> **–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–∞**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `parse_event` –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è bearer-—Ç–æ–∫–µ–Ω–∞.
	-> **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ user_id** (—Ñ—É–Ω–∫—Ü–∏—è `_resolve_user_id`):
		1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —è–≤–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–≥–æ `user_id` –≤ query/body (–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏).
		2. –ï—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω ‚Äî –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ authorizer context (`requestContext.authorizer.user_payload`).
		3. –ï—Å–ª–∏ authorizer –Ω–µ—Ç ‚Äî –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è Bearer JWT —Å `verify_exp=False`.
		4. –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—Ç `400 Bad Request` –∏–ª–∏ `401 Unauthorized`.
	-> **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ YDB**: –ü–æ–ª—É—á–µ–Ω–∏–µ credentials —á–µ—Ä–µ–∑ `ydb_creds_from_env()`, —Å–æ–∑–¥–∞–Ω–∏–µ –ø—É–ª–æ–≤ –¥–ª—è `jwt-database` –∏ `firms-database`.
	-> **–°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ**: –ó–∞–ø—Ä–æ—Å –∫ `jwt-database.users` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è `user_id`, `email`, `user_name`. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî `404 Not Found`.
	-> **–°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∏—Ä–º–∞—Ö**:
		-> –ó–∞–ø—Ä–æ—Å –∫ `firms-database.Users` –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤—Å–µ—Ö **–ê–ö–¢–ò–í–ù–´–•** –∑–∞–ø–∏—Å–µ–π (`is_active = true`) –ø–æ `user_id`.
		-> –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ `firm_ids`.
		-> –ó–∞–ø—Ä–æ—Å –∫ `firms-database.Firms` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (`firm_id`, `firm_name`, `owner_user_id`, `integrations`).
	-> **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞**: –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ JSON —Å –ø–æ–ª—è–º–∏ `user_id`, `email`, `user_name`, `firms`.
	-> **CORS –∏ anti-cache –∑–∞–≥–æ–ª–æ–≤–∫–∏**: –í—Å–µ –æ—Ç–≤–µ—Ç—ã –≤–∫–ª—é—á–∞—é—Ç `Cache-Control: no-cache`, `Pragma: no-cache`, `Expires: 0` –∏ CORS-–∑–∞–≥–æ–ª–æ–≤–∫–∏.

–ù–∞ –≤—ã—Ö–æ–¥–µ:
	-> `200 OK`: `{"user_id": "...", "email": "...", "user_name": "...", "firms": [{"firm_id": "...", "firm_name": "...", "owner_user_id": "...", "integrations": {...}}]}`
	-> `400 Bad Request`: –ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.
	-> `401 Unauthorized`: –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
	-> `404 Not Found`: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ `jwt-database`.
	-> `500 Internal Server Error`: –í —Å–ª—É—á–∞–µ –æ—à–∏–±–æ–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–ª–∏ —Ä–∞–±–æ—Ç—ã —Å –ë–î.

---
#### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
- **–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —É—Ç–∏–ª–∏—Ç—ã**: 
	- `utils/util_log/logger.py` - JsonLogger –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
	- `utils/util_http/cors.py` - cors_headers, handle_preflight –¥–ª—è CORS
	- `utils/util_http/request.py` - parse_event –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
	- `utils/util_http/response.py` - ok, bad_request, server_error –¥–ª—è HTTP-–æ—Ç–≤–µ—Ç–æ–≤
	- `utils/util_errors/exceptions.py` - AppError, Unauthorized, NotFound, Internal
	- `utils/util_errors/to_response.py` - app_error_to_http –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –æ—à–∏–±–æ–∫
	- `utils/util_json/index.py` - loads_safe –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
	- `utils/util_ydb/credentials.py` - ydb_creds_from_env –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è credentials
	- `utils/util_ydb/driver.py` - get_session_pool –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ YDB
	- `utils/util_crypto/jwt_tokens.py` - verify_jwt –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ JWT
- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**: –ì–∏–±–∫–∞—è –º–æ–¥–µ–ª—å —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ (—è–≤–Ω—ã–π user_id ‚Üí authorizer ‚Üí bearer JWT)
- **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**:
	- `SA_KEY_JSON` - JSON –∫–ª—é—á —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ (–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ Lockbox ‚Üí ENV)
	- `YDB_ENDPOINT`, `YDB_DATABASE` ([[üíæ jwt-database - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö YandexDatabase.md]])
	- `YDB_ENDPOINT_FIRMS`, `YDB_DATABASE_FIRMS` ([[üíæ firms-database - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö YandexDatabase.md]])
	- `JWT_SECRET` - –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ JWT (–µ—Å–ª–∏ authorizer –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
	- `CORS_ALLOW_ORIGIN` ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "*"
