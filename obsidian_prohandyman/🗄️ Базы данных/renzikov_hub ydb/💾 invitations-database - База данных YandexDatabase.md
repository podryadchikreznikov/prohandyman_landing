
---
Идентификатор - [БУДЕТ_СОЗДАН]
Путь к базе - [БУДЕТ_СОЗДАН]
Эндпоинт - [БУДЕТ_СОЗДАН]

---
# Описание

База данных для хранения кодов приглашений и запросов на присоединение к фирмам.

## Структура

### Папка `invitation_codes`

Содержит таблицы с кодами приглашений для каждой фирмы.

#### Таблица: `codes_{firm_id}`

Динамически создаваемая таблица для каждой фирмы.

| #   | Имя                  | Ключ | Тип         | Описание                                                      |
| --- | -------------------- | ---- | ----------- | ------------------------------------------------------------- |
| 0   | `code_id`            | PK   | `Utf8`      | Уникальный идентификатор кода (UUID)                          |
| 1   | `code_value`         |      | `Utf8`      | Значение кода (8-значная строка)                              |
| 2   | `firm_id`            |      | `Utf8`      | ID фирмы                                                      |
| 3   | `created_at`         |      | `Timestamp` | Время создания кода                                           |
| 4   | `created_by_user_id` |      | `Utf8`      | ID пользователя, создавшего код                               |
| 5   | `expires_at`         |      | `Timestamp` | Время истечения кода                                          |
| 6   | `max_usage_count`    |      | `Int32`     | Максимальное количество использований (-1 = безлимит)         |
| 7   | `current_usage`      |      | `Int32`     | Текущее количество использований                              |
| 8   | `is_active`          |      | `Bool`      | Активен ли код                                                |
| 9   | `is_instant`         |      | `Bool`      | Моментальное присоединение без подтверждения                  |
| 10  | `object_id`          |      | `Utf8`      | ID объекта стройки (опционально)                              |
| 11  | `metadata_json`      |      | `Json`      | Дополнительная метаинформация                                 |

**Индексы:**
- `idx_code_value` на `code_value` для быстрого поиска по значению кода
- `idx_firm_active` на `(firm_id, is_active)` для получения активных кодов фирмы

#### Таблица: `instant_code_{firm_id}`

Специальная таблица для краткосрочных кодов (живут 10 минут).

| #   | Имя           | Ключ | Тип         | Описание                        |
| --- | ------------- | ---- | ----------- | ------------------------------- |
| 0   | `firm_id`     | PK   | `Utf8`      | ID фирмы                        |
| 1   | `code_value`  |      | `Utf8`      | Значение краткосрочного кода    |
| 2   | `created_at`  |      | `Timestamp` | Время создания                  |
| 3   | `expires_at`  |      | `Timestamp` | Время истечения (created_at+10m)|

---

### Папка `join_requests`

Содержит таблицы с запросами на присоединение.

#### Таблица: `requests_{firm_id}_{code_id}`

Динамически создаваемая таблица для каждой комбинации фирма+код.

| #   | Имя                           | Ключ | Тип         | Описание                                    |
| --- | ----------------------------- | ---- | ----------- | ------------------------------------------- |
| 0   | `request_id`                  | PK   | `Utf8`      | Уникальный идентификатор запроса (UUID)     |
| 1   | `code_id`                     |      | `Utf8`      | ID кода приглашения                         |
| 2   | `firm_id`                     |      | `Utf8`      | ID фирмы                                    |
| 3   | `user_id`                     |      | `Utf8`      | ID пользователя, запрашивающего вступление  |
| 4   | `requested_at`                |      | `Timestamp` | Время создания запроса                      |
| 5   | `dispatcher_id`               |      | `Utf8`      | ID диспетчера (опционально)                 |
| 6   | `likes_count_at_request`      |      | `Int32`     | Количество лайков на момент запроса         |
| 7   | `dislikes_count_at_request`   |      | `Int32`     | Количество дизлайков на момент запроса      |
| 8   | `blocks_count_at_request`     |      | `Int32`     | Количество блокировок на момент запроса     |
| 9   | `status`                      |      | `Utf8`      | Статус: PENDING, APPROVED, REJECTED         |
| 10  | `processed_at`                |      | `Timestamp` | Время обработки запроса                     |
| 11  | `processed_by_user_id`        |      | `Utf8`      | ID пользователя, обработавшего запрос       |
| 12  | `rejection_reason`            |      | `Utf8`      | Причина отклонения (если REJECTED)          |

**Индексы:**
- `idx_status` на `status` для фильтрации по статусу
- `idx_user` на `user_id` для поиска запросов пользователя

---

## Примечания

- Все таблицы создаются динамически при первом использовании
- Коды истекают автоматически по `expires_at`
- Краткосрочные коды обновляются автоматически если истекли
- Запросы APPROVED добавляют пользователя в фирму автоматически
